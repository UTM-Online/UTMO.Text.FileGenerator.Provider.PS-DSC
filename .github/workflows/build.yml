# This workflow will build a .NET project
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-net

name: .NET

on:
  push:
    branches: [ "main" ]
    paths:
      - "src/**"
  workflow_dispatch:

env:
  VERSION: 3.3.${{ github.run_number }}
  SOLUTION: src/UTMO.Text.FileGenerator.Provider.PS-DSC.slnx

jobs:
  build:
    permissions:
      contents: write
      packages: write
      id-token: write
      attestations: write

    runs-on: 
      group: OnPremRunners

    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        continue-on-error: true
        with:
          global-json-file: src/global.json

      - name: Restore dependencies
        run: dotnet restore ${{ env.SOLUTION }}

      - name: Build
        run: dotnet build ${{ env.SOLUTION }} --no-restore

      - name: Test
        run: dotnet test ${{ env.SOLUTION }} --no-build --verbosity normal

      - name: Package
        run: dotnet pack ${{ env.SOLUTION }} -c Release -o '${{ github.workspace }}/src/publish' /p:PackageVersion=${{ env.VERSION }}

      - name: Configure Nuget Push Target
        run: dotnet nuget add source --name PHX2 "https://packages.public.utmonline.net/nuget/TextFileGeneration/v3/index.json"

      - name: Push to Nuget
        run: dotnet nuget push '${{ github.workspace }}/src/publish/*.nupkg' --source PHX2 --skip-duplicate --api-key ${{ secrets.PACKAGES_PUSH_SECRET }}

      - name: Publish Package Metadata
        run: |
          set -ex  # Enable debug output and exit on error
          ORG_NAME=$(echo "${{ github.repository }}" | cut -d'/' -f1)
          echo "ORG_NAME: ${ORG_NAME}"
          
          for package in ${{ github.workspace }}/src/publish/*.nupkg; do
            echo "Processing package: ${package}"
            package_name=$(basename "$package" .nupkg)
            echo "Package name: ${package_name}"
            
            # Calculate SHA256 digest of the package
            package_digest=$(sha256sum "$package" | cut -d' ' -f1)
            echo "Package digest: ${package_digest}"
            
            # Write JSON to a temp file using printf for maximum reliability
            printf '%s' '{"name":"'"${package_name}"'","digest":"sha256:'"${package_digest}"'","logical_environment":"production","deployment_name":"nuget-publish-'"${{ env.VERSION }}"'"}' > /tmp/payload.json
            
            echo "=== Payload file contents ==="
            cat /tmp/payload.json
            echo ""
            echo "=== Payload file hex dump (first 200 bytes) ==="
            xxd /tmp/payload.json | head -20
            echo "=== Validating JSON with jq ==="
            jq . /tmp/payload.json || echo "JSON is invalid!"
            echo "=== Sending request ==="
            
            curl -L --fail-with-body \
              -X POST \
              -H "Accept: application/vnd.github+json" \
              -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              -H "Content-Type: application/json" \
              "https://api.github.com/orgs/${ORG_NAME}/artifacts/metadata/deployment-record" \
              -d @/tmp/payload.json \
              -v 2>&1 || echo "Request failed with exit code $?"
          done

      - name: Create GitHub Release
        run: gh release create v${{ env.VERSION }} --title "Release ${{ env.VERSION }}" --generate-notes
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Publish Build Artifacts
        uses: actions/upload-artifact@v6
        with:
          name: published-app
          path: '${{ github.workspace }}/src/UTMO.Text.FileGenerator/publish'
