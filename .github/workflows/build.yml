# This workflow will build a .NET project
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-net

name: .NET

on:
  push:
    branches: [ "main" ]
    paths:
      - "src/**"
  workflow_dispatch:

env:
  VERSION: 3.3.${{ github.run_number }}
  SOLUTION: src/UTMO.Text.FileGenerator.Provider.PS-DSC.slnx

jobs:
  build:

    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          global-json-file: src/global.json

      - name: Restore dependencies
        run: dotnet restore ${{ env.SOLUTION }}

      - name: Build
        run: dotnet build ${{ env.SOLUTION }} --no-restore

      - name: Test
        run: dotnet test ${{ env.SOLUTION }} --no-build --verbosity normal

      - name: Package
        run: dotnet pack ${{ env.SOLUTION }} -c Release -o '${{ github.workspace }}/src/publish' /p:PackageVersion=${{ env.VERSION }}

      - name: Configure Nuget Push Target
        run: dotnet nuget add source --name PHX2 "https://packages.public.utmonline.net/nuget/TextFileGeneration/v3/index.json"

      - name: Push to Nuget
        run: dotnet nuget push '${{ github.workspace }}/src/publish/*.nupkg' --source PHX2 --skip-duplicate --api-key ${{ secrets.PACKAGES_PUSH_SECRET }}

      - name: Publish Package Metadata
        run: |
          ORG_NAME=$(echo "${{ github.repository }}" | cut -d'/' -f1)
          for package in ${{ github.workspace }}/src/publish/*.nupkg; do
            package_name=$(basename "$package" .nupkg)
            curl -L \
              -X POST \
              -H "Accept: application/vnd.github+json" \
              -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              "https://api.github.com/orgs/${ORG_NAME}/artifacts/metadata/deployment-record" \
              -d "{\"artifact_url\":\"https://packages.public.utmonline.net/nuget/TextFileGeneration/${package_name}.${{ env.VERSION }}.nupkg\",\"source_repository_url\":\"https://github.com/${{ github.repository }}\",\"status\":\"deployed\"}"
          done

      - name: Create GitHub Release
        run: gh release create v${{ env.VERSION }} --title "Release ${{ env.VERSION }}" --generate-notes
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Publish Build Artifacts
        uses: actions/upload-artifact@v6
        with:
          name: published-app
          path: '${{ github.workspace }}/src/UTMO.Text.FileGenerator/publish'
