{% extends 'script_base' %}
{% block script %}
[DscLocalConfigurationManager()]
Configuration LocalConfigApplication
{
    node {{ node_name }}
    {
        Settings
        {
            RefreshFrequencyMins = {{ lcm_settings.RefreshFrequencyMins }};
            RefreshMode = '{{ lcm_settings.RefreshMode }}';
            ConfigurationMode = '{{ lcm_settings.ConfigurationMode }}';
            AllowModuleOverwrite = {{ lcm_settings.AllowModuleOverwrite }};
            RebootNodeIfNeeded = {{ lcm_settings.RebootNodeIfNeeded }};
            ConfigurationModeFrequencyMins = {{ lcm_settings.ConfigurationModeFrequencyMins }};
        }

        {{ resource_repository_web.lcm_resource_type }} {{ resource_repository_web.lcm_resource_name }}
        {
            ServerURL = '{{ resource_repository_web.server_url }}'
            RegistrationKey = '{{ registration_key }}'{% if resource_repository_web.configuration_names != empty %}
            ConfigurationNames = @({% for cfg in resource_repository_web.configuration_names %}'{{ cfg }}'{% if forloop.last == false  %},{% endif %}{% endfor %}{% if has_local_configuration %},'{{ node_name }}'{% endif %}){% endif %}
        }

        {{ report_server_web.lcm_resource_type }} {{ report_server_web.lcm_resource_name }}
        {
            ServerURL = '{{ report_server_web.server_url }}'
            RegistrationKey = '{{ registration_key }}'{% if report_server_web.configuration_names != empty %}
            ConfigurationNames = @({% for cfg in report_server_web.configuration_names %}'{{ cfg }}'{% if forloop.last == false  %},{% endif %}{% endfor %}{% if has_local_configuration %},'{{ node_name }}'{% endif %}){% endif %}
        }

        {{ pull_server_web.lcm_resource_type }} {{ pull_server_web.lcm_resource_name }}
        {
            ServerURL = '{{ pull_server_web.server_url }}'
            RegistrationKey = '{{ registration_key }}'{% if pull_server_web.configuration_names != empty %}
            ConfigurationNames = @({% for cfg in pull_server_web.configuration_names %}'{{ cfg }}'{% if forloop.last == false  %},{% endif %}{% endfor %}{% if has_local_configuration %},'{{ node_name }}'{% endif %}){% endif %}
        }

{% for cfg in partial_configs %}
        PartialConfiguration {{ cfg.FullName }}
        {
            Description = '{{ cfg.Description }}'
            RefreshMode = '{{ cfg.Mode }}'{%- if cfg.Mode == 'Pull' %}
            ResourceModuleSource = '[ResourceRepositoryWeb]{{ cfg.module_source }}'
            ConfigurationSource = '[ConfigurationRepositoryWeb]{{ cfg.config_source }}'{%- endif %}
        }{% if forloop.last == false %}
{% endif %}{% endfor %}{% if has_local_configuration %}
    
        PartialConfiguration {{ node_name }}
        {
            Description = 'Per-node configuration'
            RefreshMode = 'Pull'
            ResourceModuleSource = '[ResourceRepositoryWeb]{{ resource_repository_web.lcm_resource_name }}'
            ConfigurationSource = '[ConfigurationRepositoryWeb]{{ pull_server_web.lcm_resource_name }}'
        }{% endif %}
    }
}

LocalConfigApplication -OutputPath $OutputPath{% endblock %}